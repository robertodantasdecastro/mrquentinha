# Changelog (por sprint)

## 27/02/2026
- T9.2.1-A2-HF5 (accounts/auth): login JWT de contas `CLIENTE` passou a exigir `email_verified_at`; quando pendente, o backend retorna bloqueio com instrucao para validar e-mail.
- T9.2.1-A2-HF5 (accounts/email): template de confirmacao evoluiu para HTML com identidade visual (logo do Web Client) e dados dinâmicos da empresa vindos do CMS (`PortalConfig` + secao `footer`).
- T9.2.1-A2-HF5 (accounts/email): validade do token ajustada para 3 horas (`ACCOUNTS_EMAIL_VERIFICATION_TOKEN_TTL_HOURS`, default `3`), mantendo invalidação automática do token anterior a cada reenvio.
- T9.2.1-A2-HF5 (accounts/api): `POST /api/v1/accounts/email-verification/resend/` passou a aceitar fluxo público por `identifier` (usuario/e-mail), além do fluxo autenticado.
- T9.2.1-A2-HF5 (web client): confirmação de e-mail agora redireciona automaticamente para `/conta?email_confirmed=1`; tela de login mostra ação de reenvio de token quando o backend bloquear login por e-mail não validado.
- T9.2.1-A2-HF4 (accounts/email verification): cadastro web cliente passou a exigir e-mail e enviar confirmacao com token; links agora apontam para `/conta/confirmar-email` no frontend cliente com URL dinamica por ambiente (origem ativa no DEV Cloudflare/IP e fallback para `PortalConfig.client_base_url`).
- T9.2.1-A2-HF4 (accounts/backend): adicionados campos de verificacao em `UserProfile` (`email_verified_at`, token hash, timestamps e ultima base URL), endpoints `GET /api/v1/accounts/email-verification/confirm/` e `POST /api/v1/accounts/email-verification/resend/`.
- T9.2.1-A2-HF4 (users admin): payload de `GET /api/v1/accounts/users/` evoluiu com status de e-mail confirmado e conformidade de dados essenciais para autenticacao/pagamentos (`essential_profile_complete`, `missing_essential_profile_fields`), refletido no painel `/modulos/usuarios-rbac`.
- T9.2.1-A2-HF4 (web client): nova rota `/conta/confirmar-email` para validar token via API, status visual de e-mail confirmado na area autenticada e botao de reenvio de confirmacao quando pendente.
- T9.2.1-A2-HF4 (qa backend): testes ampliados em `tests/test_accounts_api.py` cobrindo envio de e-mail no cadastro, confirmacao de token e reenvio com origem dinamica.
- T9.2.1-A2-HF3 (web client/conta): corrigido erro `Cannot read properties of null (reading 'value')` em `onChange` de login/cadastro, trocando leitura tardia de `event.currentTarget.value` dentro de updater por captura imediata em variavel local.
- T9.2.1-A2-HF2 (dev cloudflare/frontends): `allowedDevOrigins` dos tres frontends (`client`, `admin`, `portal`) atualizado para incluir `*.trycloudflare.com`, removendo bloqueio de recursos internos `/_next/*` em modo DEV com tunel Cloudflare.
- T9.2.6-A2-HF1 (web/ui): `FormFieldGuard` endurecido com `try/catch` em `input/blur/submit` para evitar crash client-side ao digitar em formularios controlados no Web Client/Admin/Portal.
- T9.2.6-A2-HF1 (qualidade web): validado com `npm run lint` e `npm run build` em `web/client`, `web/admin` e `web/portal`.
- T9.2.1-A2 (qa manual): rodada manual E2E iniciada com relatorio formal de execucao em `docs/memory/T9_2_1_A2_RELATORIO_EXECUCAO_2026-02-27.md` e checklist completo por blocos A..E.
- T9.2.1-A2 (pre-check): smoke baseline executado (`smoke_stack_dev` e `smoke_client_dev`) + checks de API/CORS no Cloudflare DEV para iniciar a campanha manual.
- T6.3.2-A14-HF3 (cloudflare dev/parser): leitura dos logs `cloudflare-dev-*.log` endurecida para aceitar apenas URLs publicas validas `*.trycloudflare.com` e ignorar o endpoint interno `api.trycloudflare.com`.
- T6.3.2-A14-HF3 (cloudflare dev/runtime): start dos tunnels por servico passou a recriar o log no inicio (`write/truncate`) para evitar reaproveitamento de URLs antigas em ciclos de refresh.
- T6.3.2-A14-HF3 (cloudflare dev/auto-apply): sincronizacao de `portal/client/admin/api` no `PortalConfig` passou a aceitar atualizacao parcial dos canais disponiveis, preservando modo hibrido local+cloudflare e CORS consistente.
- T6.3.2-A14-HF3 (backend CORS): `dev.py` recebeu `CORS_ALLOWED_ORIGIN_REGEXES` para aceitar dominios aleatorios `https://*.trycloudflare.com` sem quebrar o acesso por IP local.
- T6.3.2-A14-HF3 (qualidade): validado com `python manage.py check`, `ruff check`, `black --check` e `pytest tests/test_portal_services.py tests/test_portal_api.py` (`30 passed`).
- T6.3.2-A14-HF1 (cloudflare dev/frontends): hotfix implementado para corrigir comunicacao dos frontends publicados por dominios `trycloudflare` com a API publicada em dominio aleatorio dedicado.
- T6.3.2-A14-HF1 (runtime discovery): adicionado endpoint local de runtime (`/api/runtime/config`) em `admin`, `client` e `portal` para resolver dinamicamente `api_base_url` via `PortalConfig` no backend, reduzindo dependencia de `.env.local` e de restart manual.
- T6.3.2-A14-HF1 (start scripts): `start_admin_dev.sh`, `start_client_dev.sh` e `start_portal_dev.sh` passaram a resolver `NEXT_PUBLIC_API_BASE_URL` automaticamente a partir do backend (`/api/v1/portal/config`) quando variavel/env local nao estiver definida.
- T6.3.2-A14-HF1 (qualidade): validado com `npm run lint` e `npm run build` em `web/admin`, `web/client` e `web/portal`, alem de `python manage.py check` e `pytest tests/test_portal_services.py tests/test_portal_api.py` no backend.
- T6.3.2-A14-HF1 (validacao externa): os dominios `trycloudflare` informados para API/frontends retornaram `Cloudflare 530 (Error 1033)` durante o teste desta sessao; necessario reexecutar a validacao publica apos reativar o runtime DEV do Cloudflare.
- T6.3.2-A14-HF2 (rede local DEV): `runtime/config` de `admin`, `client` e `portal` passou a priorizar `http://<host-local>:8000` quando o frontend for acessado por IP/localhost na rede local, mesmo com Cloudflare DEV ativo no backend.
- T6.3.2-A14-HF2 (portal UX): links de `Gestao` e `Area do Cliente` em `Header/Footer` e `Home` do Portal foram ajustados para resolver host local dinamicamente sem erro de hidratacao.
- T6.3.2-A14-HF2 (qualidade): validado com `npm run lint` e `npm run build` em `web/admin`, `web/client` e `web/portal`; validado por `curl` em `http://10.211.55.21:{3000,3001,3002}/api/runtime/config` retornando `api_base_url=http://10.211.55.21:8000`.
- T9.2.6-A1 (accounts/backend): criado `UserProfile` em `accounts` com dados adicionais completos (dados pessoais, endereco, documentos, fotos e biometria), incluindo migration `0002_userprofile`.
- T9.2.6-A1 (accounts/api): novo endpoint autenticado `GET/PATCH /api/v1/accounts/me/profile/` com suporte a JSON e multipart para upload de foto de perfil, digitalizacao de documentos (frente/verso/selfie) e biometria facial por foto.
- T9.2.6-A1 (web admin): nova area `Meu perfil` em `/perfil`, adicionada na navegacao de todos os templates (`classic`, `admin-adminkit`, `admin-admindek`), com formulario completo, upload por camera (`capture`) e acao de logoff.
- T9.2.6-A1 (qualidade): testes de `accounts` ampliados para cobrir autorizacao, criacao automatica de perfil, atualizacao textual e upload de imagens de perfil/documentos/biometria.
- T9.2.6-A2 (ecosistema web): implementada camada global de formatacao/validacao de formularios em `@mrquentinha/ui` (`FormFieldGuard`) aplicada no `admin`, `client` e `portal`.
- T9.2.6-A2 (campos sensiveis): mascaras e validacoes automáticas para CPF, CNPJ, CEP, email, senha e datas (com `type=\"date\"` para melhor experiencia touch no mobile quando aplicavel).
- T9.2.6-A2 (backend): politicas de validacao reforcadas para senha de cadastro (`accounts/register`) e para recebedor de pagamentos no Portal CMS (`payment_providers.receiver` com validacao de CPF/CNPJ e email).
- T9.2.6-A2 (qualidade): validado com `ruff`, `black`, `pytest` direcionado (accounts/portal) e `npm run lint && npm run build` nos tres frontends web.
- T6.3.2-A9 (Portal CMS/Cloudflare): novo modulo de exposicao online com `cloudflare_settings` no backend, preview de rotas e toggle de ativacao/desativacao com 1 clique no Web Admin.
- T6.3.2-A9 (backend/API): novos endpoints admin:
  - `POST /api/v1/portal/admin/config/cloudflare-preview/`
  - `POST /api/v1/portal/admin/config/cloudflare-toggle/`
  com atualizacao automatica de `api_base_url`, URLs de frontend e `cors_allowed_origins`.
- T6.3.2-A9 (coexistencia de modos): suporte explicito a `local_only`, `cloudflare_only` e `hybrid` (padrao recomendado), mantendo snapshot local para rollback rapido.
- T6.3.2-A9 (qualidade): `ruff check` backend e `npm run lint && npm run build` no `web/admin` executados com sucesso; `pytest` backend bloqueado nesta sessao por indisponibilidade do PostgreSQL local.
- T6.3.2-A10 (Cloudflare runtime): adicionada acao admin `POST /api/v1/portal/admin/config/cloudflare-runtime/` para `start|stop|status` do processo `cloudflared`, com PID/log em `.runtime/ops`.
- T6.3.2-A10 (monitoramento): `GET /api/v1/orders/ops/realtime/` passou a incluir servico `cloudflare` no bloco `services`.
- T6.3.2-A10 (operacao): novo script `scripts/cloudflare_tunnel.sh` com comandos `start|stop|restart|status|logs`.
- T6.3.2-A11 (Cloudflare DEV): `cloudflare_settings` evoluiu com `dev_mode` + `dev_urls` para operar desenvolvimento com dominios aleatorios `trycloudflare.com` sem exigir dominio real configurado.
- T6.3.2-A11 (runtime DEV): `POST /api/v1/portal/admin/config/cloudflare-runtime/` passou a iniciar/parar 4 tunnels dev (portal/client/admin/api), capturar URLs publicas por log e sincronizar `dev_urls` no `PortalConfig`.
- T6.3.2-A11 (auto-aplicacao): quando `auto_apply_routes` estiver ativo, as URLs aleatorias do DEV atualizam automaticamente `api_base_url`, `portal/client/admin base_url` e `cors_allowed_origins`.
- T6.3.2-A11 (web admin): secao `Portal CMS > Conectividade > Cloudflare` ganhou toggle `Modo DEV com dominios aleatorios (trycloudflare)`, bloqueio de campos de dominio/tunnel no modo DEV e exibicao das URLs geradas por servico no card de runtime.
- T6.3.2-A11 (qualidade): validado com `python manage.py check`, `pytest tests/test_portal_services.py tests/test_portal_api.py`, `black --check`, `ruff check`, `npm run lint` e `npm run build` no Web Admin.
- T6.3.2-A12 (terminal/cloudflare): criado `scripts/cloudflare_admin_cli.py` com wrapper `scripts/cloudflare_admin.sh` para operar DEV/PROD via terminal usando os mesmos endpoints do Web Admin (`status`, `dev-up`, `dev-refresh`, `dev-down`, `preview-prod`, `prod-up`, `prod-refresh`, `prod-down`).
- T6.3.2-A12 (sync frontends): criado `scripts/cloudflare_sync_frontends.sh` para atualizar `.env.local` de `admin/client/portal` com a URL atual da API (incluindo rotacao de URLs `trycloudflare`).
- T6.3.2-A12 (start scripts): `scripts/start_admin_dev.sh` e `scripts/start_client_dev.sh` agora priorizam `NEXT_PUBLIC_API_BASE_URL` vindo de `.env.local` antes do fallback local, evitando sobrescrever o endpoint sincronizado pelo Cloudflare DEV.
- T6.3.2-A12 (documentacao): README, README_EXECUTIVO e runbooks atualizados com fluxos DEV/PROD via Web Admin e via terminal.
- T6.3.2-A13 (monitoramento DEV): runtime Cloudflare passou a retornar conectividade por servico (`portal/client/admin/api`) com status (`online/offline`), `http_status`, `latency_ms`, URL verificada e timestamp do check.
- T6.3.2-A13 (web admin): secao Cloudflare ganhou botao `Gerar novos dominios DEV` (acao `refresh`) e painel de monitoramento de conectividade dos dominios aleatorios.
- T6.3.2-A13 (backend): endpoint `cloudflare-runtime` passou a aceitar `action=refresh` para reiniciar tunnels DEV e gerar novos dominios automaticamente.
- T6.3.2-A13 (teste real): tentativa de teste ponta a ponta com runtime DEV executada; ambiente atual bloqueado por ausencia do binario `cloudflared` no servidor de desenvolvimento.
- T6.3.2-A14 (runtime sync): `status` do runtime DEV passou a sincronizar automaticamente `dev_urls` rotacionadas e reaplicar `api_base_url`/URLs de frontends no `PortalConfig` quando houver mudanca.
- T6.3.2-A14 (backend host): ambiente `dev` passou a aceitar `*.trycloudflare.com` em `ALLOWED_HOSTS` para evitar `DisallowedHost` na API via dominio aleatorio.
- T6.3.2-A14 (operacao): novo script `scripts/install_cloudflared_local.sh` para instalar `cloudflared` em `.runtime/bin` sem dependencia de pacote do sistema.
- T6.3.2-A14 (teste real): validacao executada com `refresh` real e dominios aleatorios gerados; monitoramento por servico estabilizou em `online` (`portal/client/admin/api`) e sincronizacao de URLs no payload publico confirmada.

## 26/02/2026
- T9.2.5 (web admin template): novo template `admin-admindek` adicionado ao CMS/Admin com layout completo inspirado no padrão AdminDek (sidebar gradiente, header operacional, cards executivos, visual CRM/ecommerce/finance).
- T9.2.5 (ui/admin): shell, estilos globais, formularios, navegação de modulos e wizard operacional refinados para variação visual por template sem quebrar a identidade oficial do Mr Quentinha.
- T9.2.5 (preload template-aware): preload inline e overlay global do Admin passaram a suportar também o template `admin-admindek`.
- T9.2.4 (preload template-aware): preloads do ecossistema web padronizados por template em `admin`, `client` e `portal`, com variacoes visuais para `admin-classic/admin-adminkit`, `client-classic/client-quentinhas/client-vitrine-fit` e `classic/letsfit-clean`.
- T9.2.4 (preload route + overlay): componentes de preload inline e overlay global passaram a respeitar identidade de cada template, preservando contraste e hierarquia visual durante carregamento de paginas e dados.
- T9.2.3 (web admin templates): backend `PortalConfig` evoluiu para suportar `admin_active_template` e `admin_available_templates`, com validacao, serializacao publica (`channel=admin`) e persistencia no CMS.
- T9.2.3 (web admin): estrutura de layout passou a suportar templates dinamicos do painel com provider dedicado, seletor de template no modulo `Portal CMS` e novo template inicial `admin-adminkit` inspirado no modelo AdminKit.
- T9.2.3 (ux/ix operacao): incluido modulo `Fluxo Operacional Guiado` (`/modulos/fluxo-operacional`) com navegacao passo a passo (anterior/proxima etapa) cobrindo receitas/cardapio, compras, producao, pedidos, financeiro e relatorios.
- T9.2.3 (visual/charts): paleta e componentes de graficos do Admin refinados por template com contraste e hierarquia visual para dashboards e relatorios detalhados.
- T9.2.2 UX preload (web): implementado preload global e por rota nos frontends `admin`, `client` e `portal` com `loading.tsx`, overlay de rede e componentes visuais padronizados para todos os estados de carregamento de dados.
- T9.2.2 UX preload (integracao): wrappers de API do Admin/Client e fetch client-side do Portal passaram a publicar estado de requisições para monitoramento de carregamento em tempo real na UI.
- T9.2.2 UX preload (qualidade): validado com sucesso em `npm run lint` e `npm run build` para os tres frontends web.
- T7.2.4-A2 (backend/orders): roteamento de provider por canal de frontend implementado com `frontend_provider.web/mobile`, resolucao por header (`X-Client-Channel`) e fallback seguro para `WEB`.
- T7.2.4-A2 (web client): criacao de intent passou a enviar `X-Client-Channel: WEB`, garantindo selecao de gateway por canal no backend.
- T7.2.4-A2 (admin web/Portal CMS): secao `Pagamentos` passou a selecionar provider unico por canal (`Web Cliente` e `App Mobile`) e a exibir campos dinamicos conforme provider selecionado.
- T7.2.4-A3 (backend/orders): endpoint de monitoramento realtime do ecossistema publicado em `GET /api/v1/orders/ops/realtime/` com saude de servidor, status de servicos, monitor de comunicacao com gateways e lifecycle de pedidos.
- T7.2.4-A3 (admin web): dashboard principal ganhou cards realtime de servicos/pagamentos e novo modulo dedicado `/modulos/monitoramento` com polling a cada 10s.
- Qualidade: adicionados testes para `orders ops realtime` e propagacao de canal `MOBILE` no fluxo de intent; validado com `python manage.py check`, `ruff check`, `pytest` direcionado, `npm run lint` e `npm run build` (admin/client).
- T7.2.4-A1 (backend/orders): `payment_providers.py` evoluido para Mercado Pago, Efi e Asaas com selecao dinamica por metodo (`PIX/CARD/VR`) via configuracao do Portal CMS.
- T7.2.4-A1 (backend/orders): novos webhooks dedicados por provider publicados em `/api/v1/orders/payments/webhook/{mercadopago|asaas|efi}/`.
- T7.2.4-A1 (backend/portal): `PortalConfig` ganhou `payment_providers` (JSON) com recebedor CPF/CNPJ, ordem por metodo e credenciais por provider; endpoint admin de teste `POST /api/v1/portal/admin/config/test-payment-provider/` adicionado.
- T7.2.4-A1 (admin web): modulo `/modulos/portal` ganhou secao `Pagamentos` com configuracao completa de gateways, habilitacao por provider, roteamento por metodo e botao de teste de conexao.
- T7.2.4-A1 (web client): checkout agora respeita `payment_providers` publico para habilitar metodos dinamicamente e exibir instrucoes de intent com `checkout_url`/PIX aprimorado.
- T7.2.4-A1 (qualidade): testes adicionados para webhooks Mercado Pago/Asaas/Efi em `tests/test_orders_api.py` e regressao backend executada com sucesso.
- ADR-0006 criada: decisao arquitetural de pagamentos multigateway com configuracao central no Portal CMS.
- T6.3.2-A7 (backend Portal CMS): `PortalConfig` ganhou `auth_providers` (Google/Apple) com normalizacao de payload, defaults por canal e sanitizacao publica sem segredo.
- T6.3.2-A7 (backend Portal CMS): novo template cliente `client-vitrine-fit` adicionado na configuracao oficial de templates do canal client.
- T6.3.2-A7 (admin web): modulo `/modulos/portal` ganhou secao `Autenticacao social` para gerenciar parametros OAuth web/mobile de Google e Apple.
- T6.3.2-A7 (web client): novo template `client-vitrine-fit` aplicado em layout/header/footer/jornada de cardapio com prioridade para fotos.
- T6.3.2-A7 (web client): pagina `/conta` ganhou painel de login social Google/Apple orientado por configuracao do CMS, com callbacks em `/conta/oauth/google/callback` e `/conta/oauth/apple/callback`.
- Mobile brand contract: `mobile/brand` atualizado para incluir leitura de `auth_providers` no payload publico do Portal CMS.
- Planejamento global atualizado com meta `T9.2.1` para campanha recorrente de testes manuais E2E e checklist publicado em `docs/memory/PLANO_T9_2_1_TESTES_MANUAIS_E2E.md`.
- Validacao de retomada: `bash scripts/sync_memory.sh --check` e `bash scripts/quality_gate_all.sh` executados com sucesso (`148 passed` no backend + builds/smokes em `OK`).
- Admin Web: novo modulo `Portal CMS` em `/modulos/portal` para selecionar template ativo entre os templates cadastrados no backend.
- Admin Web: adicionadas rotas de servico do modulo (`/modulos/portal/[service]`) para acesso direto em `template` e `publicacao`.
- Admin Web: cliente de API ganhou suporte aos endpoints de administracao do portal (`list/create/patch/publish` em `/api/v1/portal/admin/config/`).
- Admin Web: dashboard de modulos atualizado com card do `Portal CMS` na etapa `T6.3.2`.
- Qualidade: `bash scripts/quality_gate_all.sh` executado com sucesso apos a entrega.
- Portal Web: integracao de template com CMS concluida no render server-side (`/api/v1/portal/config/`), removendo dependencia de `NEXT_PUBLIC_PORTAL_TEMPLATE`.
- Portal Web: `layout` e `home` agora leem `active_template` em tempo de requisicao e aplicam fallback seguro para `classic`.
- Operacao: servico do Portal (porta `3000`) reiniciado para carregar a integracao.
- Portal Web: fallback automatico da API de cardapio para host atual (`:8000`) quando `NEXT_PUBLIC_API_BASE_URL` nao estiver definido.
- Web Client: fallback automatico da API para host atual (`:8000`) + tratamento amigavel de falha de rede em `requestJson`.
- Portal Web: ajuste de `next.config.ts` com `allowedDevOrigins` para IP da VM e `images.unsplash.com` em `images.remotePatterns`.
- Admin Web (Cardapio): nova secao de composicao para cadastrar ingredientes e pratos (quentinhas) com receita.
- Admin Web (Compras): fluxo completo de compra operacional com selecao de cardapio, geracao de requisicao e registro de compra com itens.
- Admin Web (Cardapio): suporte a periodos de refeicao (Manha/Cafe, Almoco, Jantar, Lanche) para padronizar titulos de menu no ciclo diario.
- Portal CMS (backend): `PortalConfig` ganhou `client_active_template` e `client_available_templates`, com validacao dedicada e suporte a payload publico por `channel=client`.
- Portal CMS (backend): versionamento publico (`/api/v1/portal/config/version`) passou a considerar secoes e template ativo de portal + cliente no fingerprint.
- Admin Web (`/modulos/portal`): configuracao do canal Web Cliente adicionada com seletor dedicado de template e resumo de templates por canal.
- Web Cliente (3001): layout passou a ler template ativo do CMS em runtime (`/api/v1/portal/config/?channel=client&page=home`) com fallback seguro para `client-classic`.
- Web Cliente (3001): tema `client-quentinhas` finalizado com variaveis visuais e adaptacoes em header/footer/jornada do cardapio.
- Hotfix build client: erro de prerender resolvido com `\"use client\"` no `Footer` apos introducao do hook de template.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`129 passed`, builds Portal/Client/Admin e smokes `stack/client`).
- Portal CMS (backend): nova camada de conectividade no `PortalConfig` com campos de dominio/subdominio e URLs de Portal/Client/Admin/API/Proxy, alem de `cors_allowed_origins`.
- Portal CMS (backend): defaults de ambiente local adicionados com host `mrquentinha` e hardening para preencher origens CORS quando o singleton ja existia sem configuracao.
- Admin Web (`/modulos/portal`): nova secao `Conectividade` para editar host local, dominios/subdominios, URLs de apps e allowlist de CORS (uma origem por linha), com botao de preset local.
- Admin Web (`/modulos/portal`): menu/descricoes atualizados para refletir gerenciamento de templates + conectividade.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`130 passed`, builds Portal/Client/Admin e smokes `stack/client`).
- Portal CMS (backend): `PortalConfig` passou a expor `api_base_url` e o dominio publico derivado para unificar links de download do app.
- Portal CMS (backend): novo modelo `MobileRelease` com ciclo `create -> compile -> publish`, snapshot de API/host e endpoint publico de ultima release em `/api/v1/portal/mobile/releases/latest/`.
- Admin Web (`/modulos/portal/mobile-build`): nova secao de build/release mobile com criacao, compilacao inicial e publicacao de releases.
- Portal Web (`/app`): QR e botoes de download agora consomem a release publicada via API; rota `/app/downloads/[target]` adicionada para redirecionamento controlado.
- Hotfix portal (Next 16): ajuste de tipagem da route dinamica de downloads para `params` assincrono.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`133 passed`, builds Portal/Client/Admin e smokes `stack/client`).
- T8.0.1 (docs-first): discovery de Financas Pessoais concluido com definicao de escopo MVP tecnico (`personal_finance`), ownership estrito por usuario e requisitos LGPD minimos.
- ADR-0003 criada: segregacao entre financeiro operacional (`finance`) e trilha pessoal (`personal_finance`) com API dedicada e isolamento de dados.
- Planejamento atualizado: `ROADMAP_MASTER`, `BACKLOG`, `PROJECT_STATE` e `10-plano-mvp-cronograma` sincronizados para apontar `T8.1.1` como proxima execucao.
- T8.1.1 (backend): novo app `personal_finance` com modelos `PersonalAccount`, `PersonalCategory`, `PersonalEntry` e `PersonalBudget`, incluindo migration inicial.
- T8.1.1 (backend): API autenticada publicada em `/api/v1/personal-finance/` com CRUD de contas/categorias/lancamentos/orcamentos e isolamento por ownership.
- T8.1.1 (qualidade): testes adicionados em `tests/test_personal_finance_api.py` e endpoint raiz atualizado com `personal_finance`.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`138 passed`, builds Portal/Client/Admin e smokes `stack/client`).
- T8.1.2 (backend/LGPD): adicionados endpoint de exportacao de dados pessoais (`/api/v1/personal-finance/export/`) e endpoint de consulta de trilha de auditoria (`/api/v1/personal-finance/audit-logs/`).
- T8.1.2 (backend/LGPD): criada entidade `PersonalAuditLog` para registrar eventos de leitura/escrita/exportacao no dominio pessoal.
- T8.1.2 (operacao): novo comando `python manage.py purge_personal_audit_logs --days 730` para aplicar retencao de logs de auditoria pessoal.
- T8.1.2 (qualidade): testes adicionados em `tests/test_personal_finance_lgpd.py` cobrindo exportacao, auditoria e retencao.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`142 passed`, builds Portal/Client/Admin e smokes `stack/client`).
- T8.2.1 (docs-first): discovery da evolucao da trilha pessoal concluido com priorizacao de recorrencia de lancamentos, resumo mensal e importacao CSV MVP.
- ADR-0005 criada: estrategia de evolucao em fases da trilha pessoal preservando segregacao de dominio e idempotencia.
- Planejamento atualizado: `ROADMAP_MASTER`, `BACKLOG`, `PROJECT_STATE`, `REQUIREMENTS_BACKLOG` e `10-plano-mvp-cronograma` sincronizados para apontar `T8.2.2` como proxima execucao tecnica.
- T8.2.2 (backend/API): adicionados `PersonalRecurringRule` e `PersonalImportJob`, com novos endpoints para recorrencia, resumo mensal e importacao CSV (preview/confirmacao).
- T8.2.2 (idempotencia): `PersonalEntry` passou a suportar `recurring_event_key` e `import_hash` com constraints de unicidade por owner para evitar duplicidade em reprocessamentos.
- T8.2.2 (qualidade): testes de financas pessoais ampliados para cobrir recorrencia idempotente, resumo mensal e deduplicacao de importacao CSV.
- Validacao final: `bash scripts/quality_gate_all.sh` executado com sucesso (`146 passed`, builds Portal/Client/Admin e smokes `stack/client`).

## 25/02/2026
- Backend: adicionadas exportacoes CSV (pedidos, compras, producao, fluxo de caixa e DRE) com headers em pt-BR.
- Admin Web: modulo `/modulos` agora e client component; hotpages divididas em `sections.tsx` para evitar export nomeado em `page.tsx` (fix do `next build`).
- Admin Web: corrigido uso de `yield_portions` no cardapio para evitar erro de tipagem.
- Admin Web: rota `/modulos` marcada como client component para evitar erro de build ao importar `AdminSessionGate`.
- Admin Web: modulos agora possuem subpaginas por servico (`/modulos/<modulo>/<secao>`), com menus atualizados.
- Admin Web: dashboards dos modulos (cardapio, compras, estoque, pedidos, producao, financeiro, relatorios, usuarios/RBAC) ligados a dados reais do backend.
- Admin Web: adicionados consumos de relatorios financeiros (cashflow) e correcao de endpoint em compras.
- Backend: `seed_demo` ampliado com novos ingredientes e pratos (marmitas/acompanhaments) para dados ficticios mais realistas.
- Ops Center atualizado com Admin Web (porta 3002), atalhos g/h/j e layout mais amigavel.
- Ops Center ganhou modos de ajuda, logs e compacto para operacao diaria, com cards clicaveis por servico.
- Ops Center ganhou modal de conexoes SSH + logs de autenticacao e botao [SSH] no header.
- Novo launcher `scripts/ops_dashboard.py` (mantendo `ops_dashboard.sh` como entrypoint).
- Script `scripts/start_admin_dev.sh` adicionado para subir o Admin Web.
- T9.1.1 concluida: modulo Usuarios/RBAC no backend e Admin Web (listagem de usuarios, listagem de papeis e atribuicao de roles com escopo ADMIN).
- T6.1.1 concluida: proxy local Nginx em `127.0.0.1:8088` com hosts `www/admin/api/app` e smoke dedicado.
- VM dev atualizada com instalacao de `nginx` para suporte ao proxy local.
- `docs/memory/PATHS_AND_PORTS.md`, `docs/memory/RUNBOOK_DEV.md` e README atualizados com proxy local e scripts oficiais.

## Sprint 0
- Marca oficial definida: Mr Quentinha (assets/brand/)
- Documentacao inicial criada
- Regras do Codex definidas em `AGENTS.md`
- Etapa 0 bootstrap
- Bootstrap valida versoes estaveis de git/python/node/postgres
- Bootstrap usa Node.js LTS como base minima
- Corrigido `scripts/bootstrap_dev_vm.sh`:
  - extracao de versao por comando funcionando
  - versoes minimas ajustadas para baseline realista (Git 2.30, Python 3.11, Node 20, PostgreSQL 15)
  - checklist final sem erro de `printf`
- Etapa 1 scaffold backend:
  - estrutura Django em `workspaces/backend` com padrao `src/`
  - settings por ambiente (`dev` e `prod`) via `.env` com `django-environ`
  - endpoint `GET /api/v1/health` com payload padronizado
  - apps criados: accounts, catalog, inventory, procurement, orders, finance, ocr_ai
  - qualidade configurada com `ruff`, `black` e `pytest` (Makefile com comandos de lint/test)
  - teste automatizado para health endpoint

- Etapa 2 catalogo:
  - dominio `catalog` com modelos: Ingredient, Dish, DishIngredient, MenuDay e MenuItem
  - migrations iniciais do catalog aplicadas
  - service layer em `services.py` para criacao/atualizacao de pratos e cardapio do dia
  - selectors em `selectors.py` para consulta de ingredientes ativos e cardapio por data
  - API DRF em `/api/v1/catalog/...` com endpoint `menus/by-date/<YYYY-MM-DD>/`
  - regra MVP: itens de cardapio embutidos em `MenuDay` (`items` escrita e `menu_items` leitura)
  - testes pytest cobrindo modelos, services, selectors e endpoints de catalog

- Docs/Bootstrap: aviso sobre CREATEDB para testes

- Etapa 2 encerrada:
  - resumo do entregue:
    - CRUD de catalogo (ingredientes, pratos/receitas com composicao e cardapio por dia)
    - endpoint de consulta por data (`/api/v1/catalog/menus/by-date/<YYYY-MM-DD>/`)
    - service layer (`services.py`) e selectors (`selectors.py`) aplicados no dominio
    - testes automatizados cobrindo modelos, services/selectors e endpoints
  - comandos de validacao usados:
    - `python manage.py check`
    - `python manage.py makemigrations --check`
    - `python manage.py migrate`
    - `make lint`
    - `make test`

- Etapa 3 estoque/compras:
  - INVENTORY MVP com `StockItem` e `StockMovement` integrado a `Ingredient`.
  - regras de estoque em service layer (`apply_stock_movement`) com bloqueio de saldo negativo em `OUT`.
  - PROCUREMENT MVP com `PurchaseRequest`, `PurchaseRequestItem`, `Purchase` e `PurchaseItem`.
  - criacao de compra aplica entrada de estoque automaticamente (`StockMovement` tipo `IN`).
  - API DRF adicionada:
    - `/api/v1/inventory/stock-items/`
    - `/api/v1/inventory/movements/`
    - `/api/v1/procurement/requests/`
    - `/api/v1/procurement/purchases/`
  - testes pytest cobrindo regras de estoque, compras com impacto em saldo e endpoints API.

- Etapa 3.1 auto-requisicao por cardapio:
  - novo service `generate_purchase_request_from_menu(menu_day_id, requested_by=None)` em procurement.
  - calculo de necessidade por ingrediente com base em `MenuDay -> MenuItem -> DishIngredient`.
  - regra MVP de multiplicador: `available_qty` quando informado; caso contrario, `1` lote por prato.
  - validacao explicita de unidade sem conversao automatica (TODO documentado para conversao futura).
  - endpoint DRF adicionado: `POST /api/v1/procurement/requests/from-menu/`.
  - sem falta de ingredientes: retorna `created=false` e nao cria `PurchaseRequest`.
  - testes pytest cobrindo cenarios sem estoque, estoque suficiente, estoque parcial e endpoint HTTP.

- Docs: roadmap estendido (Etapas 6-8)
  - visao geral atualizada com ecossistema completo: mobile cliente, web gestao, portal institucional e web clientes.
  - escopo MVP reforcado com fechamento operacional nas etapas 4 e 5.
  - cronograma mantido ate M5 e ampliado com bloco pos-MVP (Etapas 6, 7 e 8) com dependencias.
  - deploy EC2 documentado com estrutura de dominios planejada (`www`, `admin`, `api`, `app`).
  - decisions atualizadas com pendencias de stack do portal, PWA e segregacao de dados pessoais.

> Atualize a cada sprint com o que foi entregue.

- Etapa 4 pedidos:
  - dominio `orders` implementado com modelos `Order`, `OrderItem` e `Payment`.
  - services com regras de negocio para criacao de pedido e transicao de status.
  - validacoes: cardapio por data, `menu_item` da data correta e snapshot de preco no item.
  - criacao automatica de `Payment` com status `PENDING` no MVP.
  - API DRF adicionada:
    - `/api/v1/orders/orders/`
    - `/api/v1/orders/orders/<id>/status/`
    - `/api/v1/orders/payments/`
  - testes pytest cobrindo service e endpoint de criacao de pedido.

- Etapa 4 encerrada:
  - resumo do que foi entregue:
    - modulo `orders` consolidado com `Order`, `OrderItem` e `Payment` no MVP.
    - validacoes de pedido por `MenuDay`/`delivery_date` e bloqueio de itens fora da data.
    - total do pedido calculado no service com snapshot de preco (`unit_price`) em `OrderItem`.
    - transicoes de status centralizadas no service e pagamento inicial `PENDING` criado automaticamente.
    - endpoints publicados para pedidos, alteracao de status e pagamentos.
  - comandos de validacao:
    - `python manage.py check`
    - `python manage.py makemigrations --check`
    - `python manage.py migrate`
    - `make lint`
    - `make test`

- Etapa 5.0 finance foundation:
  - modulo `finance` estruturado com modelos:
    - `Account`
    - `APBill`
    - `ARReceivable`
    - `CashMovement`
  - padrao de integracao por referencia implementado em AP/AR:
    - `reference_type` + `reference_id`
    - unique por referencia quando preenchida
  - service layer em `finance/services.py` com idempotencia:
    - `create_default_chart_of_accounts()`
    - `create_ap_from_purchase()` (stub para integracao completa na 5.1)
    - `create_ar_from_order()` (stub para integracao completa na 5.2)
    - `record_cash_in_from_ar()` e `record_cash_out_from_ap()`
  - API DRF adicionada:
    - `/api/v1/finance/accounts/`
    - `/api/v1/finance/ap-bills/`
    - `/api/v1/finance/ar-receivables/`
    - `/api/v1/finance/cash-movements/`
  - admin basico registrado para os modelos financeiros.
  - testes pytest cobrindo:
    - unicidade de `Account`
    - idempotencia de AP/AR por referencia
    - criacao de movimentos de caixa IN/OUT
    - endpoints basicos de finance

- Etapa 5.1 AP integrado a compras:
  - fluxo de `procurement` atualizado para gerar `APBill` automaticamente ao criar `Purchase`.
  - regra de referencia aplicada no AP: `reference_type="PURCHASE"` e `reference_id=<purchase.id>`.
  - idempotencia reforcada no service financeiro: reprocessamento da mesma compra retorna o AP existente sem duplicar.
  - fallback de valor no AP: quando `Purchase.total_amount` estiver zerado, o valor e calculado pelos itens (`qty * unit_price + tax_amount`).
  - testes de service e API adicionados para validar integracao compra -> AP.

- Etapa 5.2 AR + caixa por pagamento:
  - `orders.create_order` passou a gerar `ARReceivable` automaticamente (referencia `ORDER` + `order.id`).
  - AR criado com conta de receita padrao `Vendas` e vencimento no `delivery_date` do pedido.
  - ao atualizar `Payment` para `PAID`, o fluxo liquida o AR (`RECEIVED`) e gera `CashMovement` `IN`.
  - `CashMovement IN` usa conta patrimonial padrao `Caixa/Banco` (ASSET).
  - idempotencia aplicada em service: reprocessamento de `PAID` nao duplica AR nem movimento de caixa.
  - testes de service e API cobrindo pedido -> AR e pagamento -> caixa.

- Etapa 5.3 relatorio cashflow:
  - criado modulo de relatorios financeiros com `get_cashflow(from_date, to_date)`.
  - novo endpoint `GET /api/v1/finance/reports/cashflow/?from=YYYY-MM-DD&to=YYYY-MM-DD`.
  - retorno por dia com `total_in`, `total_out`, `net` e `running_balance`.
  - validacoes de entrada adicionadas (`from`/`to` obrigatorios e `from <= to`).
  - testes de relatorio e API cobrindo agregacao e saldo acumulado.

- Etapa 5.4 producao + consumo de estoque:
  - novo modulo `production` com modelos `ProductionBatch` e `ProductionItem`.
  - endpoint de lotes de producao publicado em `/api/v1/production/batches/` com acao `POST /<id>/complete/`.
  - conclusao de lote consome ingredientes por receita (`DishIngredient`) e gera `StockMovement` `OUT` com referencia `PRODUCTION`.
  - integracao com `inventory.services.apply_stock_movement` para reaproveitar regra de bloqueio de saldo negativo.
  - idempotencia no fechamento de lote: reprocessamento de `complete_batch` nao duplica movimentos.
  - testes pytest cobrindo criacao de lote, consumo de estoque, bloqueio por saldo insuficiente, idempotencia e endpoint `complete`.

- Etapa 5.5 custos + DRE + KPIs:
  - relatorios financeiros estendidos com custo medio ponderado de ingrediente, custo de prato e custo de item do cardapio.
  - DRE simplificada por periodo adicionada em `/api/v1/finance/reports/dre/`.
  - KPIs financeiros adicionados em `/api/v1/finance/reports/kpis/` (pedidos, ticket medio, margem media, receita, despesas, CMV estimado e lucro bruto).
  - premissa MVP documentada: receita por pedidos `DELIVERED` e CMV estimado por itens vendidos.
  - validacao de parametros `from`/`to` reaproveitada para `cashflow`, `dre` e `kpis`.
  - testes automatizados cobrindo custos, DRE/KPIs e endpoints de relatorio.

- DX: testes no root (Makefile + pytest config)
  - Makefile no root com delegacao para `workspaces/backend` (`test`, `lint`, `format`, `check`).
  - `pytest.ini` no root para executar testes do backend.
  - `conftest.py` no root para garantir `workspaces/backend/src` no `sys.path`.

- Etapa 5.6.1 ledger de auditoria financeira:
  - novo modelo `LedgerEntry` no modulo `finance` para trilha de auditoria financeira.
  - tipos de entrada MVP: `AP_PAID`, `AR_RECEIVED`, `CASH_IN`, `CASH_OUT`, `ADJUSTMENT`.
  - idempotencia por constraint unica em (`reference_type`, `reference_id`, `entry_type`).
  - integracao em services:
    - `record_cash_in_from_ar` registra ledger `AR_RECEIVED` e `CASH_IN`.
    - `record_cash_out_from_ap` registra ledger `AP_PAID` e `CASH_OUT`.
  - endpoint read-only publicado em `/api/v1/finance/ledger/`.
  - testes adicionados para idempotencia de ledger em AR/AP e listagem do endpoint.

- Etapa 5.6.2 conciliacao:
  - modelos adicionados no `finance`: `BankStatement` e `StatementLine`.
  - `CashMovement` estendido com `statement_line` e `is_reconciled`.
  - services de conciliacao criados:
    - `reconcile_cash_movement(cash_movement_id, statement_line_id)`
    - `unreconcile_cash_movement(cash_movement_id)`
  - idempotencia da conciliacao implementada (mesma linha nao duplica nem falha).
  - endpoint de pendencias publicado: `GET /api/v1/finance/reports/unreconciled/?from=...&to=...`.
  - endpoints de conciliacao publicados:
    - `POST /api/v1/finance/cash-movements/<id>/reconcile/`
    - `POST /api/v1/finance/cash-movements/<id>/unreconcile/`

- Etapa 5.6.3 fechamento mensal:
  - novo modelo `FinancialClose` para registrar fechamento por periodo com snapshot em `totals_json`.
  - service `close_period(period_start, period_end, closed_by=None)` para consolidar DRE + cashflow no momento do fechamento.
  - endpoint `POST/GET /api/v1/finance/closes/` publicado para criar e listar fechamentos.
  - endpoint auxiliar `GET /api/v1/finance/closes/is-closed/?date=YYYY-MM-DD` publicado.
  - bloqueio por periodo fechado aplicado no service layer para operacoes de `CashMovement`, `APBill`, `ARReceivable` e `LedgerEntry`.
  - testes de service e API adicionados para fechamento, duplicidade, bloqueios e consulta `is-closed`.

- Etapa 6.0 portal scaffold:
  - criado app `workspaces/web/portal` com Next.js (App Router) + TypeScript + Tailwind.
  - paginas implementadas: `/`, `/cardapio`, `/app`, `/contato`.
  - componentes base implementados: `Header`, `Footer`, `Hero`, `CardapioList`, `QRDownloadCard`.
  - tema light/dark aplicado com tokens da marca (paleta laranja/grafite).
  - integracao de cardapio por data via `NEXT_PUBLIC_API_BASE_URL` em `/api/v1/catalog/menus/by-date/YYYY-MM-DD/`.
  - pagina `/app` com QR Code para `https://www.mrquentinha.com.br/app` e botoes Android/iOS (placeholders documentados).
  - README do portal atualizado com setup local, env vars e build.
  - docs de deploy EC2 atualizadas com nota de deploy do portal via reverse proxy ou build estatico.

- Etapa 6.0.1 hardening portal (dev origins + audit + scripts):
  - `next.config.ts` atualizado com `allowedDevOrigins` para desenvolvimento local/VM.
  - `npm audit fix` executado sem `--force`; vulnerabilidades high restantes documentadas no README do portal.
  - scripts de DX criados no root:
    - `scripts/start_backend_dev.sh`
    - `scripts/start_portal_dev.sh`
  - README do root atualizado com fluxo rapido para subir backend + portal.

- Fix: ALLOWED_HOSTS dev para VM
  - settings carregam `ALLOWED_HOSTS` via env com default local (`localhost`, `127.0.0.1`).
  - adicionado `CSRF_TRUSTED_ORIGINS` via env (default vazio) para ambiente de desenvolvimento.
  - `.env.example` e `README` do backend atualizados com exemplos para acesso via IP da VM.

- DX: stack dev perfeito (API index, CORS, smoke script)
  - backend com endpoint raiz `/` (API index) e rota de `/favicon.ico` para evitar 404 em dev.
  - CORS em dev com `django-cors-headers` e `CORS_ALLOWED_ORIGINS` via `.env` (sem abrir prod).
  - ajustes de docs/env para acesso por IP da VM (`ALLOWED_HOSTS`, `CSRF_TRUSTED_ORIGINS`, `CORS_ALLOWED_ORIGINS`).
  - script `scripts/smoke_stack_dev.sh` criado para validar backend + portal automaticamente.

- Etapa 7.0 web cliente MVP:
  - novo app `workspaces/web/client` com Next.js App Router + TypeScript + Tailwind.
  - layout mobile-first com navbar simples (`Cardapio`, `Meus pedidos`, `Conta`) e tema light/dark.
  - pagina de cardapio com consulta por data em `GET /api/v1/catalog/menus/by-date/YYYY-MM-DD/`.
  - carrinho local com controle de quantidade, total e finalizacao de pedido.
  - criacao de pedidos integrada em `POST /api/v1/orders/orders/`.
  - historico de pedidos em `/pedidos` com filtro demo best-effort no frontend.
  - README do client atualizado com setup, envs e observacoes de integracao.

- DX: start/smoke client + fix lock next dev
  - diagnostico e limpeza de lock/processo do Next no client (`.next/dev/lock`).
  - novo script `scripts/start_client_dev.sh` com:
    - encerramento gracioso de processo antigo na porta `3001` (SIGINT -> SIGTERM);
    - limpeza de lock stale quando nao houver `next dev` ativo;
    - defaults de env para `NEXT_PUBLIC_API_BASE_URL` e `NEXT_PUBLIC_DEMO_CUSTOMER_ID`.
  - novo script `scripts/smoke_client_dev.sh` para subir client em background, validar `/, /pedidos, /cardapio` e encerrar processos ao final.
  - `npm audit fix` executado sem `--force`; pendencias `high` de cadeia `eslint/minimatch` documentadas no README do client.

- DX: smoke_client_dev mais robusto (wait + exit codes)
  - espera ativa com timeout para disponibilidade do client (`/` -> 200) sem ruido de conexao no terminal.
  - falha explicita quando o processo do client encerra antes de subir ou quando estoura timeout.
  - em falha, imprime log do client e retorna exit code diferente de zero.
  - cleanup via trap `EXIT` mantendo encerramento dos processos do Next e limpeza de porta.

- Dynamic e2e (backend + portal + client):
  - backend com suporte de midia (`MEDIA_URL`/`MEDIA_ROOT`) e uploads de imagens para catalogo/procurement.
  - OCR MVP funcional com `OCRJob`, parser de rotulo/comprovante, fallback simulado por `raw_text` e endpoint de aplicacao (`/apply`).
  - modelo nutricional no catalogo com `NutritionFact` por 100g/ml e porcao opcional.
  - comando `seed_demo` cobrindo cadeia completa (catalogo, compras, estoque, producao, pedidos, financeiro e OCR).
  - pacote compartilhado `workspaces/web/ui` e padrao visual clean aplicado em portal/client.
  - portal e client com consumo dinamico da API via `NEXT_PUBLIC_API_BASE_URL`, incluindo imagens de pratos.
  - scripts atualizados para fluxo ponta a ponta (`seed_demo.sh`, `smoke_stack_dev.sh`) e runbook dev publicado.

- Docs/Workflow atualizados:
  - novo `docs/memory/PROJECT_STATE.md` com estado real de portas, scripts, endpoints e envs (sem segredos).
  - novo `docs/memory/RUNBOOK_DEV.md` com operacao completa de dev/seed/smoke/OCR.
  - atualizados `docs/00-visao-geral.md`, `docs/10-plano-mvp-cronograma.md`, `docs/07-workflow-codex.md`, `docs/templates/prompt_codex_base.md`, `docs/03-modelo-de-dados.md` e `docs/memory/DECISIONS.md`.

- Antigravity: regras, workflows e memoria do projeto adicionados
  - criadas regras globais em `.antigravity/rules.md` e espelhos operacionais em `.agent/rules/`.
  - criada memoria ativa versionada em `.agent/memory/` (`MEMORY_INDEX`, `CONTEXT_PACK`, `TODO_NEXT`).
  - criados workflows operacionais em `.agent/workflows/` cobrindo bootstrap, loop diario, backend, frontend, quality gate, docs e release checkpoint.
  - criados prompts base para agentes em `.agent/prompts/` (system, backend, frontend, data seed e bugfix).
  - `docs/memory/PROJECT_STATE.md` e `docs/memory/RUNBOOK_DEV.md` atualizados com estado real, quickstart, smoke e troubleshooting.

- Antigravity: workflows adicionais de sessao, bugfix, refactor, QA, PR e release
  - adicionados workflows W10-W20 para lifecycle completo de trabalho.
  - criado `SESSION_COMMANDS.md` com macros operacionais para iniciar/continuar/salvar/corrigir/auditar/release.
  - adicionados templates de prompts para sessao, bugfix, refactor, quality e docs.
  - memoria `.agent/memory` atualizada com index de workflows e contexto operacional vigente.

- Docs: GLOBAL_RULE Antigravity + guia de uso de workflows
  - adicionada regra-mae em `.antigravity/GLOBAL_RULE.md` com mapa do repo, padroes e politica de segredos.
  - adicionados guias `.agent/workflows/USAGE_GUIDE.md` e `.agent/workflows/WORKFLOW_MAP.md`.
  - atualizados `SESSION_COMMANDS`, `CONTEXT_PACK` e `PROJECT_STATE` para refletir o estado atual.
  - criado helper `scripts/session.sh` para atalhos `start`, `continue`, `save` e `qa`.

- Infra: regra global de sync Codex <-> Antigravity + scripts de sincronizacao
  - criada regra global unificada (`GLOBAL_SYNC_RULE`) e regra operacional (`.agent/rules/sync.md`).
  - definido `SYNC_PACK` com arquivos obrigatorios de memoria/documentacao.
  - criado workflow `W21_sync_codex_antigravity` para sincronizacao obrigatoria pre-commit.
  - criados scripts `sync_memory.sh`, `quality_gate_all.sh` e `commit_sync.sh`.
  - atualizado workflow do Codex e guia de uso do Antigravity para incluir fluxo de sync.

- Infra: antigravity global rule path fix
  - regra global operacional adicionada em `.agent/rules/global.md`
  - espelho para topo do painel criado em `.agent/rules/00_GLOBAL_RULE.md`
  - mapeamento de paths documentado em `.agent/rules/README.md`
  - docs atualizadas com compatibilidade de paths Codex/Antigravity

- DX: painel operacional estilo btop para stack local
  - novo app terminal `scripts/ops_center.py` com monitoramento de CPU, memoria, trafego e acessos HTTP
  - controle de servicos no painel (start/stop/restart backend, portal e client)
  - monitoramento de fontes de acesso do frontend por conexoes TCP nas portas 3000/3001
  - launcher dedicado `scripts/ops_dashboard.sh`

- DX: export de metricas do painel em JSONL/CSV
  - `scripts/ops_center.py` recebeu flags `--export-json`, `--export-csv` e `--export-interval`
  - export automatico diario em `.runtime/ops/exports/ops_YYYYMMDD.{jsonl,csv}`
  - cada amostra inclui sistema (CPU/memoria/rede), servicos, eventos e fontes de acesso do frontend

- Branch policy (Codex x Antigravity x Join) + smoke compativel com RBAC:
  - definida politica anti-conflito com branch principal do Codex (`feature/etapa-4-orders`), branches `ag/<tipo>/<slug>` e branch de integracao `join/codex-ag`.
  - criado `scripts/branch_guard.sh` para validar branch por agente em modo strict.
  - workflows W12/W18/W21 atualizados com validacao de branch e fluxo de integracao join.
  - smoke do stack ajustado para usar endpoint publico read-only de cardapio (`GET /api/v1/catalog/menus/today/`).
  - backend manteve RBAC para CRUD e liberou apenas leitura minima publica (`by-date` e `today`) para MVP.

- Infra/Workflow: harmonizacao Codex <-> Antigravity (sem duplicacao)
  - `W10..W21` definidos como fonte de verdade para operacao humana.
  - `00..06` consolidados como wrappers curtos que apenas encaminham para os `W*`.
  - branch policy aplicada nos fluxos com commit/push/merge via `scripts/branch_guard.sh`.
  - quality gate e sync padronizados com ativacao de venv backend e `nvm use --lts` para npm.
  - criada documentacao de trabalho paralelo com lock humano (`IN_PROGRESS.md`) e mapa oficial de workflows.

- Branch policy atualizada (main/AntigravityIDE/Antigravity_Codex):
  - politica canonica ajustada para `main` (Codex), `AntigravityIDE` (Antigravity) e `Antigravity_Codex` (uniao).
  - regra de branches por etapa formalizada:
    - Codex: `main-etapa-N-TituloEtapa`
    - Antigravity: `AntigravityIDE/etapa-N-TituloEtapa`
  - workflow de uniao atualizado (`W18`) com merge controlado de `origin/AntigravityIDE` em `Antigravity_Codex` e validacao completa.
  - novo script `scripts/union_branch_build_and_test.sh` com modo `--dry-run`.
  - `branch_guard.sh` atualizado para as novas branches canonicas e bloqueio de uso indevido da branch de uniao.

- Workflow audit + GEMINI sync + novos workflows:
  - auditoria completa dos workflows com reforco de branch_guard, venv e nvm quando aplicavel.
  - adicionado sincronismo GEMINI repo->global com scripts:
    - `scripts/sync_gemini_global.sh`
    - `scripts/diff_gemini.sh`
  - `W21` atualizado para validar `sync_memory --check` e `sync_gemini_global.sh --check`.
  - novos workflows adicionados:
    - `W22_layout_references_audit`
    - `W23_design_system_sync`
    - `W24_git_comparison_review`
    - `W25_recovery_readonly`
  - documentacao/memoria atualizadas para refletir policy, scripts e fluxos de recovery.

- GEMINI global-only (workflows e scripts):
  - fonte unica definida em `/home/roberto/.gemini/GEMINI.md`.
  - criado `scripts/gemini_check.sh` para validar chaves obrigatorias de branch policy.
  - `scripts/sync_gemini_global.sh` desativado (stub com orientacao para `gemini_check`).
  - workflows W10/W11/W12/W18/W21 atualizados para validar GEMINI global antes de branch/push/union.
  - `WORKFLOW_MAP` e `USAGE_GUIDE` revisados para remover dependencia de GEMINI do repositorio.

- Etapa 6.2 portal template letsfit-clean:
  - refatoracao da estrutura base com `TemplateProvider` suportando `NEXT_PUBLIC_PORTAL_TEMPLATE` (`classic` e `letsfit-clean`).
  - novo diretorio de componentes `letsfit` em `src/components/letsfit` contendo Hero, BenefitsBar, Categories, KitSimulator, HowToHeat, Faq.
  - novas paginas integradas `/sobre` e `/como-funciona`.
  - reestruturacao da home `/` para renderizar `HomeLetsFit` ou `HomeClassic` de acordo com o template.
  - aprimoramento do componente dinamico `CardapioList` para chamar endpoint `/today/` quando for a data corrente.
  - roteamento dinâmico visual nos headers e footers via construtos React ContextClient.
  - script the protecao de branches `branch_guard.sh` atualizado para habilitar hifen (`-`) na policy do Antigravity.

- Etapa 7.1.1 backend auth/rbac (orders/payments por ownership):
  - `orders` agora aplica escopo por ownership para cliente autenticado em listagem e mutacao.
  - clientes podem atualizar apenas seus proprios recursos; tentativas em recursos de terceiros retornam 404.
  - papéis de gestao (`ADMIN`, `FINANCEIRO`, `COZINHA`, `COMPRAS`, `ESTOQUE`) mantem acesso global de leitura/escrita conforme matriz RBAC.
  - cobertura de testes ampliada em services e API para ownership e acesso global de gestão.

- Etapa 7.1.2 client auth real (login/register/me + refresh, sem demo):
  - `workspaces/web/client/src/lib/storage.ts` recebeu persistencia de sessao JWT (`access`/`refresh`) com funcoes de leitura/limpeza.
  - `workspaces/web/client/src/lib/api.ts` passou a enviar `Authorization: Bearer`, aplicar refresh automatico em `401` e limpar sessao quando refresh falha.
  - novos fluxos de autenticacao no client: `loginAccount`, `registerAccount`, `fetchMe`, `logoutAccount`.
  - tela `/conta` migrada para autenticacao real (bootstrap de sessao, login, cadastro, logout e exibicao de perfil/papeis).
  - modo demo removido do fluxo principal de pedidos: checkout e historico agora dependem de sessao autenticada.
  - README do client atualizado com endpoints de auth da etapa 7.1.
  - validacoes executadas: `npm run lint`, `npm run build`, `pytest tests/test_accounts_api.py tests/test_orders_api.py` e `bash scripts/quality_gate_all.sh` (OK).

- Etapa 7.1.3 fechamento auth/rbac end-to-end:
  - regressao completa executada com `bash scripts/quality_gate_all.sh` (lint + testes + builds + `smoke_stack_dev` + `smoke_client_dev`) com status OK.
  - servicos live em tmux pausados durante o quality gate para evitar conflito de porta no smoke do portal; apos o gate, stack live reativada.
  - sessoes tmux operacionais consolidadas: `backend_live`, `portal_live`, `client_live` e `codex`.
  - memoria da etapa atualizada em `PROJECT_STATE`, `CONTEXT_PACK` e `TODO_NEXT`.
  - etapa ativa movida para 7.2 (pagamentos online: PIX/cartao/VR).

- docs(plan): roadmap master + backlog + admin web + requisitos do chat
  - criada matriz de alinhamento do chat em `docs/memory/REQUIREMENTS_BACKLOG.md`.
  - criado roadmap consolidado em `docs/memory/ROADMAP_MASTER.md`.
  - criado backlog executavel P0/P1/P2 em `docs/memory/BACKLOG.md`.
  - `PROJECT_STATE`, `CONTEXT_PACK` e `TODO_NEXT` atualizados com etapa ativa 7.2 e trilhas 6.3/9.0.
  - `DECISIONS` atualizada com diretrizes de JSONField (CMS/nutricao), politica publico/privado, estrategia de templates e Admin Web.
  - `RUNBOOK_DEV` atualizado com procedimento de quality gate sem conflito com tmux live, recovery de conexao e tratamento de locks/nvm/venv.

- Etapa 7.2.1 payment intents (backend-only):
  - adicionado modelo `PaymentIntent` com idempotencia por `(payment, idempotency_key)` e payload JSON.
  - criada camada de provider (`apps/orders/payment_providers.py`) com provider default `mock` e configuracoes `PAYMENTS_PROVIDER_DEFAULT`/`PAYMENTS_INTENT_TTL_MINUTES`.
  - novos endpoints em `PaymentViewSet`:
    - `POST /api/v1/orders/payments/<id>/intent/`
    - `GET /api/v1/orders/payments/<id>/intent/latest/`
  - fluxo de status implementado com retornos `201/200/400/404/409` e replay idempotente.
  - cobertura de testes ampliada em `test_orders_services.py` e `test_orders_api.py` para cenarios de intent, ownership e conflitos.
  - validacoes executadas com sucesso:
    - `bash scripts/quality_gate_all.sh`
    - `bash scripts/smoke_stack_dev.sh`
    - `bash scripts/smoke_client_dev.sh`

- Etapa 7.2.2 webhook + reconciliacao financeira (backend-only):
  - criado modelo `PaymentWebhookEvent` com idempotencia por (`provider`, `event_id`).
  - novos contratos de API em `orders`:
    - `POST /api/v1/orders/payments/webhook/` (token via header `X-Webhook-Token`).
    - suporte a replay idempotente (`201` na primeira entrega, `200` no replay).
  - reconciliacao automatica por webhook:
    - `intent_status=SUCCEEDED` -> `Payment=PAID` + sincronizacao `AR/Cash/Ledger`.
    - `intent_status` de falha (`FAILED/CANCELED/EXPIRED`) -> `Payment=FAILED`.
  - cobertura de testes ampliada em `test_orders_api.py` para:
    - sucesso com reconciliacao,
    - replay idempotente,
    - token invalido/ausente,
    - intent inexistente,
    - falha sem entrada de caixa.
  - validacoes executadas:
    - `pytest tests/test_orders_services.py tests/test_orders_api.py` (28 passed),
    - `bash scripts/smoke_stack_dev.sh` (OK),
    - `bash scripts/smoke_client_dev.sh` (OK).

- docs(memory): sincronizacao de estado apos T7.2.2
  - `PROJECT_STATE`, `TODO_NEXT`, `CONTEXT_PACK`, `ROADMAP_MASTER` e `BACKLOG` alinhados com `T7.2.2` concluida.
  - prioridade ativa movida para `T7.2.3` (checkout online no client).

- Etapa 7.2.3 checkout online no client (PIX/CARD/VR):
  - backend passou a aceitar `payment_method` na criacao de pedido (`OrderSerializer` + `create_order`) mantendo validacao por choices.
  - cobertura de testes backend ampliada para metodo CARD e validacao de metodo invalido.
  - client integrado ao fluxo de intents:
    - selecao de metodo online no carrinho;
    - criacao de intent com `Idempotency-Key` em `POST /api/v1/orders/payments/<id>/intent/`;
    - polling manual de status em `GET /api/v1/orders/payments/<id>/intent/latest/`;
    - painel com instrucoes por metodo (PIX copia-e-cola/QR mock, token CARD, token VR).
  - historico de pedidos passou a exibir resumo dos pagamentos por pedido.
  - validacoes executadas com sucesso:
    - `cd workspaces/backend && source .venv/bin/activate && make lint`
    - `cd workspaces/backend && source .venv/bin/activate && pytest tests/test_orders_services.py tests/test_orders_api.py`
    - `cd workspaces/web/client && npm run lint && npm run build`
    - `bash scripts/smoke_client_dev.sh`

- Branch policy Codex ajustada para operacao real de Git:
  - padrao canonico de etapa em Codex atualizado para `main-etapa-*` (compativel com branch principal `main`).
  - `scripts/branch_guard.sh` passou a aceitar `main-etapa-*` e manter compatibilidade com referencias legadas.
  - memoria/workflows/rules sincronizados para o novo padrao de branch.

- docs(memory): sincronizacao de estado apos T7.2.3
  - `PROJECT_STATE`, `TODO_NEXT`, `CONTEXT_PACK`, `ROADMAP_MASTER` e `BACKLOG` atualizados.
  - etapa ativa movida para `6.3` com proxima subetapa unica `T6.3.1`.

- Etapa 6.3.1 portal cms backend-only:
  - novo app backend `portal` com modelos `PortalConfig` (singleton) e `PortalSection` (template/page/key + `body_json`).
  - novos endpoints:
    - publico: `GET /api/v1/portal/config/`, `GET /api/v1/portal/config/version`.
    - admin (MVP): `/api/v1/portal/admin/config/` e `/api/v1/portal/admin/sections/`.
  - comando idempotente de seed: `python manage.py seed_portal_default` para carga default (`classic` e `letsfit-clean`).
  - integracao no indice da API (`/`) e no roteamento principal (`config/urls.py`).
  - cobertura de testes adicionada em `tests/test_portal_services.py` e `tests/test_portal_api.py`.
  - validacoes executadas:
    - `cd workspaces/backend && source .venv/bin/activate && python manage.py check`
    - `cd workspaces/backend && source .venv/bin/activate && make lint`
    - `cd workspaces/backend && source .venv/bin/activate && pytest -q tests/test_portal_services.py tests/test_portal_api.py tests/test_api_index.py`

- docs(memory): sincronizacao apos T6.3.1
  - `PROJECT_STATE`, `TODO_NEXT` e `CONTEXT_PACK` atualizados.
  - proxima subetapa recomendada: `T9.0.1` (Admin Web MVP foundation).

- Etapa 9.0.1 admin web foundation:
  - criado novo workspace `workspaces/web/admin` (Next.js 16 + TypeScript + Tailwind + `@mrquentinha/ui`).
  - implementado shell inicial do Admin com tema light/dark e identidade visual da marca.
  - implementado fluxo de autenticacao real via JWT:
    - login em `POST /api/v1/accounts/token/`;
    - refresh automatico em `POST /api/v1/accounts/token/refresh/`;
    - bootstrap de sessao com `GET /api/v1/accounts/me/`.
  - dashboard inicial entregue com status da API (`GET /api/v1/health`) e cards de prioridade para trilhas `T9.0.2` e `T6.3.2`.
  - documentacao do admin adicionada em `workspaces/web/admin/README.md`.
  - validacoes executadas com sucesso:
    - `source ~/.nvm/nvm.sh && nvm use --lts`
    - `cd workspaces/web/admin && npm run lint`
    - `cd workspaces/web/admin && npm run build`

- docs(memory): sincronizacao apos T9.0.1
  - `PROJECT_STATE`, `ROADMAP_MASTER`, `BACKLOG`, `TODO_NEXT` e `CONTEXT_PACK` atualizados para refletir `T9.0.1` concluida.
  - etapa ativa mantida em `9.0` com proxima subetapa unica `T9.0.2`.

- Etapa 9.0.2 admin web operacional:
  - `workspaces/web/admin/src/types/api.ts` expandido com contratos de Orders/Finance/Inventory.
  - `workspaces/web/admin/src/lib/api.ts` expandido com clientes para:
    - `GET /api/v1/orders/orders/`
    - `PATCH /api/v1/orders/orders/<id>/status/`
    - `GET /api/v1/finance/reports/kpis/`
    - `GET /api/v1/finance/reports/unreconciled/`
    - `GET/POST /api/v1/inventory/movements/`
    - `GET /api/v1/inventory/stock-items/`
  - novos modulos de operacao adicionados em `workspaces/web/admin/src/components/modules/`:
    - `OrdersOpsPanel.tsx`
    - `FinanceOpsPanel.tsx`
    - `InventoryOpsPanel.tsx`
  - `AdminFoundation.tsx` conectado aos modulos operacionais no estado autenticado.
  - validacoes executadas com sucesso:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `bash scripts/quality_gate_all.sh` (`112 passed`, builds portal/client/admin e smokes OK)

- docs(memory): sincronizacao apos T9.0.2
  - `PROJECT_STATE`, `ROADMAP_MASTER`, `BACKLOG`, `REQUIREMENTS_BACKLOG`, `TODO_NEXT`, `CONTEXT_PACK`, `IN_PROGRESS` e `workspaces/web/admin/README.md` atualizados.
  - etapa ativa mantida em `9.0` com proxima subetapa unica `T9.0.3`.

- Etapa 9.0.3 admin web expansion:
  - `workspaces/web/admin/src/types/api.ts` expandido com contratos de `catalog`, `procurement` e `production`.
  - `workspaces/web/admin/src/lib/api.ts` expandido com clientes para:
    - `GET /api/v1/catalog/menu-days/`
    - `GET /api/v1/catalog/dishes/`
    - `GET /api/v1/procurement/purchase-requests/`
    - `GET /api/v1/procurement/purchases/`
    - `GET /api/v1/production/batches/`
  - novos modulos baseline adicionados em `workspaces/web/admin/src/components/modules/`:
    - `MenuOpsPanel.tsx`
    - `ProcurementOpsPanel.tsx`
    - `ProductionOpsPanel.tsx`
  - `AdminFoundation.tsx` integrado aos modulos de Cardapio/Compras/Producao no estado autenticado.
  - validacoes executadas com sucesso:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `bash scripts/quality_gate_all.sh` (`112 passed`, builds e smokes em `OK`)

- docs(memory): sincronizacao apos T9.0.3
  - `PROJECT_STATE`, `ROADMAP_MASTER`, `TODO_NEXT`, `CONTEXT_PACK`, `IN_PROGRESS` e `workspaces/web/admin/README.md` atualizados.
  - etapa ativa mantida em `9.0` com proxima subetapa unica `T9.1.1`.

- Etapa 9.1.1 admin web completo (parcial) - cardapio operacional:
  - `MenuOpsPanel.tsx` evoluido de baseline para fluxo operacional de menu do dia.
  - suporte a criar, editar e excluir cardapio (`POST/PUT/DELETE /api/v1/catalog/menus/`).
  - selecao de pratos, preco, disponibilidade e status por item no painel.
  - validacoes executadas: `cd workspaces/web/admin && npm run lint && npm run build`.

- Etapa 9.1.1 admin web completo (parcial) - compras operacional:
  - `ProcurementOpsPanel.tsx` passou a suportar geracao de requisicao por menu e update de status.
  - `lib/api.ts` expandido com:
    - `POST /api/v1/procurement/requests/from-menu/`
    - `PATCH /api/v1/procurement/requests/<id>/`
  - visualizacao de resultado da geracao por menu no painel.

- Etapa 9.1.1 admin web completo (parcial) - producao operacional:
  - `ProductionOpsPanel.tsx` passou a suportar criacao de lote por cardapio e conclusao de lote.
  - `lib/api.ts` expandido com:
    - `POST /api/v1/production/batches/`
    - `POST /api/v1/production/batches/<id>/complete/`
  - `types/api.ts` atualizado com payloads de criacao de lote e itens de producao.

- ops: admin web integrado ao ops center:
  - `scripts/start_admin_dev.sh` adicionado (porta `3002`).
  - `scripts/ops_center.py` e `scripts/ops_dashboard.sh` atualizados para controlar Admin Web.
  - `scripts/ops_dashboard.py` adicionado como launcher dedicado.

- validacao completa apos entregas parciais da T9.1.1:
  - `bash scripts/quality_gate_all.sh` em status `OK`.
  - backend `112 passed`; builds portal/client/admin e smokes em `OK`.

- Etapa 9.1.1-HF1 hotfix Admin Web login (prioridade):
  - corrigido crash client-side ao digitar no formulario de login em `AdminFoundation` (captura de `event.currentTarget.value` antes de updater assincrono de estado).
  - aplicado o mesmo hardening de `onChange` em modulos de `Orders`, `Procurement` e `Production` para evitar regressao do mesmo padrao.
  - ajustado `workspaces/web/admin/next.config.ts` para `allowedDevOrigins` no formato esperado pelo Next 16 (hostnames), liberando acesso em `http://10.211.55.21:3002`.
  - validacoes executadas com sucesso:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `./scripts/quality_gate_all.sh`
    - smoke manual de origem: `Origin 10.211.55.21 -> 200` e origem nao permitida -> `403` em `/_next/static/chunks/webpack.js`.
    - autenticacao backend validada para usuario admin `roberto` via `POST /api/v1/accounts/token/` (`200`).

- Etapa 9.1.1-HF2 hotfix Admin Web login (CORS + feedback):
  - backend `dev.py` atualizado para liberar `CORS_ALLOWED_ORIGINS` da porta `3002` (`10.211.55.21`, `localhost`, `127.0.0.1`).
  - Admin Web passou a resolver automaticamente a API base via `window.location.hostname:8000` quando `NEXT_PUBLIC_API_BASE_URL` nao estiver definida.
  - tratamento de erro de rede em `requestJson` padronizado com mensagem clara de conectividade/CORS.
  - card de login passou a exibir feedback inline (mensagem/erro) e aviso explicito quando API estiver indisponivel.
  - `scripts/start_admin_dev.sh` agora define `NEXT_PUBLIC_API_BASE_URL` padrao com IP da VM quando variavel nao existir.
  - validacoes executadas:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `./scripts/quality_gate_all.sh` (`OK`)
    - preflight CORS `Origin http://10.211.55.21:3002` em `/api/v1/accounts/token/` com `access-control-allow-origin` retornado.
    - login admin `roberto` (`POST /api/v1/accounts/token/`) e `GET /api/v1/accounts/me/` com `200`.

- Etapa 9.1.1-HF3 hotfix UX/branding global (prioridade):
  - identidade visual oficial aplicada em todo ecossistema web com assets PNG originais (`icon_app_original.png`, `logo_compact_original.png`, `logo_wordmark_original.png`) em `admin`, `portal`, `client` e `workspaces/web/public/brand/original_png`.
  - headers/footers de Admin, Portal e Client atualizados para usar a marca oficial em vez da wordmark antiga.
  - tokens de status adicionados no design system (`success`, `warning`, `danger`, `info` + variações `soft`) em `workspaces/web/ui/src/styles/tokens.css` e propagados para os `globals.css` dos três frontends.
  - novo componente compartilhado `StatusPill` adicionado no `@mrquentinha/ui`, com export de tipo `StatusTone` para padronizar badges de estado.
  - Admin Web atualizado com badges coloridos por estado em dashboard e módulos de Pedidos, Compras, Produção e Usuários/RBAC.
  - Client atualizado com badges de status no histórico de pedidos, pagamento e estado de intent no checkout.
  - validacoes executadas com sucesso:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `cd workspaces/web/portal && npm run lint && npm run build` (1 warning existente em `TemplateProvider` sem erro)
    - `cd workspaces/web/client && npm run lint && npm run build`
    - `./scripts/quality_gate_all.sh` (`114 passed`, builds portal/client/admin e smokes stack/client em `OK`).

- Etapa 9.1.1-HF4 hotfix Admin rotas de navegacao:
  - adicionadas rotas dedicadas no Admin Web para acesso direto sem 404:
    - `workspaces/web/admin/src/app/modulos/page.tsx` -> redirect para `/#modulos`.
    - `workspaces/web/admin/src/app/prioridades/page.tsx` -> redirect para `/#prioridades`.
  - objetivo: garantir compatibilidade com URL direta/bookmarks e manter navegacao por ancora da home.
  - validacoes executadas:
    - `cd workspaces/web/admin && npm run lint && npm run build`
    - `curl http://127.0.0.1:3002/modulos` -> `307` com redirect para `/#modulos`
    - `curl http://127.0.0.1:3002/prioridades` -> `307` com redirect para `/#prioridades`

- docs(memory): fechamento de ciclo no main (T9.1.1-HF3/HF4)
  - registro operacional atualizado em `.agent/memory/IN_PROGRESS.md` para retomada rapida da proxima sessao.
  - checkpoint de retomada definido: abrir branch `main-etapa-9.1.2-admin-relatorios-exportacoes` e iniciar `T9.1.2`.
  - estado confirmado no fechamento:
    - main limpo e sincronizado com `origin/main`.
    - admin em `3002` com `/` `200`, `/modulos` `307 -> /#modulos`, `/prioridades` `307 -> /#prioridades`.
    - backend auth em `8000` com `POST /api/v1/accounts/token/` retornando `200` para admin `roberto`.

- docs(memory): plano T9.1.2 Admin Web (relatorios/exportacoes + UX/IX)
  - registrado plano detalhado com escopo funcional, UX/IX, entregaveis e criterios de aceite.
  - arquivo: `docs/memory/PLANO_T9_1_2_ADMIN_RELATORIOS_UX.md`.

- T9.1.2 (parcial): hotpages e UX/IX do Admin Web
  - nova base de navegacao por modulo com hotpages e menu contextual.
  - pagina de modulos e prioridades agora sao views dedicadas (sem redirect por ancora).
  - relatorios inaugurados com pagina dedicada e graficos placeholder + exportacao CSV (UI).
  - dashboard do Admin reestruturado como hub com links diretos por modulo.
  - novos componentes de graficos simples (`Sparkline`, `MiniBarChart`) e shell de pagina de modulo.

- T9.1.2 (admin): menus filtram subpaginas por servico
  - hotpages exibem todos os blocos por padrao e filtram ao selecionar um item do menu.
  - menu contextual ganhou item `Todos` para voltar ao modo completo.
  - aplicacao do filtro em todos os modulos ativos e em Relatorios.

- T9.1.2 (admin): exportacao CSV integrada com filtros de periodo
  - filtros de periodo adicionados ao modulo de Relatorios com validacao de intervalo.
  - exportacao CSV conectada aos endpoints do backend (fluxo de caixa, compras, producao, pedidos e DRE).
  - textos ajustados para pt-BR (Relatorios/Modulos/Exportacao/Producao).
  - padronizacao de acentuacao em telas de Cardapio, Estoque, Compras, Pedidos, Financeiro e Usuarios/RBAC.
  - exportacoes dos modulos de Compras, Pedidos, Produção e Financeiro agora possuem filtro de período e download real.
  - status operacionais traduzidos para pt-BR em Pedidos, Compras e Produção (badges, selects e mensagens).
  - novo util compartilhado `workspaces/web/admin/src/lib/labels.ts` para rotulos de status.
  - Financeiro Ops ajustado para exibir margem em percentual e direcao de movimento em pt-BR.

- T9.1.2 (fechamento): etapa concluida e memoria sincronizada
  - modulo de Relatorios marcado como `ativo` no Admin Web (cards e hotpages).
  - dashboard do Admin atualizado para refletir `Etapa 9.1 concluida`.
  - arquivos de memoria sincronizados para apontar `9.1.2` como concluida e proximo passo `T6.3.2` apos lock visual `T6.2.1`.
  - validacoes finais executadas com sucesso:
    - `bash scripts/gemini_check.sh`
    - `bash scripts/sync_memory.sh --check`
    - `bash scripts/quality_gate_all.sh`

- T6.3.2-A3 (26/02/2026): midias dinamicas LetsFit multi-frontend
  - backend portal:
    - fixtures `letsfit-clean` evoluidas para seções completas (`hero`, `benefits`, `categories`, `kit`, `how_to_heat`, `faq`) com estrutura de fotos/links no `body_json`;
    - `ensure_portal_config` passou a semear secoes default quando inexistentes (idempotente);
    - `scripts/start_backend_dev.sh` agora valida escrita em `MEDIA_ROOT` antes de subir o Django.
  - admin web:
    - novo editor de conteudo dinamico no modulo Portal (`template`, `pagina`, `secao`, `body_json`);
    - upload de imagem para insumos e pratos no painel de composicao (`DishCompositionPanel`);
    - API admin tipada para secoes do portal e upload multipart de imagens.
  - portal web:
    - novo `portalTemplate.ts` com fetch server-side do payload completo do CMS;
    - home LetsFit agora renderiza componentes com dados dinamicos vindos do `body_json` (inclui fotos e CTAs).
  - mobile:
    - adicionado contrato compartilhado `workspaces/mobile/brand/contentApi.ts` para consumo dinamico de conteudo/fotos do portal e cardapio.
  - validacao executada:
    - `bash scripts/quality_gate_all.sh` (backend lint/test; build portal/client/admin; smoke stack/client) -> `OK`.

- T9.1.3-A4 (26/02/2026): fechamento do modulo Cardapio no Admin
  - `DishCompositionPanel` evoluido para fluxo completo:
    - cadastro e edicao de ingrediente (nome/unidade/status ativo);
    - cadastro e edicao de prato com composicao completa (ingredientes/quantidade/unidade);
    - upload de foto para insumo e prato mantendo o mesmo fluxo operacional.
  - `lib/api.ts` expandido com `updateIngredientAdmin` e `updateDishAdmin`.
  - `types/api.ts` expandido com `UpdateIngredientPayload` e `UpdateDishPayload`.
  - validacao executada:
    - `cd workspaces/web/admin && npm run lint`
    - `cd workspaces/web/admin && npm run build`
    - `bash scripts/quality_gate_all.sh` -> `OK`.

- T9.1.3-A5 (26/02/2026): fotos dinamicas completas no ciclo de cardapio
  - backend/catalog:
    - novo comando `sync_catalog_photos` em `src/apps/catalog/management/commands/sync_catalog_photos.py` para preencher fotos de pratos e insumos via Wikimedia Commons + fallback web;
    - fallback local em SVG implementado para garantir foto mesmo em falha de download externo, zerando falhas operacionais da sincronizacao;
    - cobertura automatizada adicionada em `tests/test_catalog_photo_sync_command.py`.
  - API catalogo:
    - `DishSummarySerializer` passou a incluir `composition` com insumos e `image_url` por ingrediente no endpoint de cardapio por data;
    - prefetch atualizado em selectors/views para evitar N+1 no carregamento da composicao.
  - frontends:
    - portal (`CardapioList`) e client (`MenuDayView`) agora exibem chips dinamicos dos insumos que compoem cada prato, incluindo foto do insumo quando disponivel;
    - contrato mobile (`workspaces/mobile/brand/contentApi.ts`) atualizado para receber `composition` com fotos dos insumos.
  - operacao executada:
    - `python manage.py sync_catalog_photos --force` aplicado no banco local com resultado final:
      - ingredientes: `19 atualizados / 0 falhas`;
      - pratos: `11 atualizados / 0 falhas`.
  - validacao executada:
    - backend: `ruff`, `black --check`, `pytest tests/test_catalog_photo_sync_command.py tests/test_catalog_api.py`;
    - frontend: `npm run lint && npm run build` em `web/portal` e `web/client`;
    - fluxo completo: `bash scripts/quality_gate_all.sh` -> `OK`.

- T9.1.3-A6 (26/02/2026): captura/upload de imagens operacionais (compras + OCR)
  - backend/ocr:
    - `apply_ocr_job` passou a aceitar `target_type=PURCHASE`;
    - ao aplicar OCR com sucesso, a foto do job agora e gravada automaticamente no destino:
      - `PURCHASE` + `RECEIPT` -> `purchase.receipt_image`;
      - `PURCHASE_ITEM` + `LABEL_FRONT/LABEL_BACK` -> `label_front_image/label_back_image`;
    - resultado do apply inclui `saved_image_field`.
  - backend/procurement:
    - novo endpoint multipart para foto de item da compra:
      - `POST/PATCH /api/v1/procurement/purchases/{id}/items/{item_id}/label-image/`
      - suporta `side=front|back`.
  - admin web/compras:
    - formulario de compra ganhou captura/upload de comprovante com `accept=\"image/*\"` + `capture=\"environment\"`;
    - cada item da compra ganhou captura/upload da foto do produto para OCR;
    - opcao de aplicar OCR automaticamente nas fotos enviadas;
    - fluxo de registro passou a:
      - criar compra,
      - subir comprovante e fotos dos itens,
      - criar/aplicar OCR automaticamente (com `raw_text` guiado para garantir processamento no MVP),
      - persistir fotos no destino final (compra/item) apos sucesso;
    - lista de compras recentes passou a exibir icones (comprovante e fotos por item).
  - admin web/cardapio:
    - upload de foto de insumo/prato tambem recebeu `capture=\"environment\"`.
  - validacao executada:
    - backend: `ruff`, `black --check`, `pytest tests/test_ocr_api.py tests/test_procurement_api.py`;
    - admin: `npm run lint && npm run build`;
    - full stack: `bash scripts/quality_gate_all.sh` -> `OK` (`124 passed`).

- T9.1.3-A7 (26/02/2026): ciclo operacional completo (linha de producao) + dashboard realtime
  - backend/orders:
    - status de pedido evoluidos para ciclo completo de entrega:
      - `OUT_FOR_DELIVERY` (saiu para entrega)
      - `RECEIVED` (cliente confirmou recebimento)
    - novas regras de transicao e permissao:
      - operacao interna: `CREATED -> CONFIRMED -> IN_PROGRESS -> OUT_FOR_DELIVERY -> DELIVERED`
      - cliente: pode cancelar apenas no inicio e confirmar recebimento quando entregue;
    - novo endpoint:
      - `POST /api/v1/orders/orders/{id}/confirm-receipt/`
    - novo dashboard operacional:
      - `GET /api/v1/orders/ops/dashboard/` com KPIs, pipeline, alertas e serie de 7 dias.
  - backend/producao:
    - conclusao de lote passou a usar `qty_planned` quando `qty_produced` nao for informado;
    - ao concluir lote, sistema atualiza `menu_item.available_qty` (descontando perdas) para refletir disponibilidade de venda.
  - backend/compras:
    - geracao de requisicao por cardapio agora dispara notificacoes para responsavel de compras:
      - email (backend de email configuravel),
      - webhook WhatsApp opcional;
    - resultado de `from-menu` agora inclui bloco `alerts` com status de envio.
  - backend/ocr:
    - ao aplicar OCR com sucesso para `PURCHASE`, sistema atualiza metadados da compra (`supplier_name`, `invoice_number`, `total_amount`) quando apropriado e persiste foto em `receipt_image`.
  - admin web:
    - dashboard inicial reestruturado para estilo linha de producao com polling a cada 30s (KPIs + alertas + pipeline clicavel).
    - cardapio ganhou opcao de auto-checagem de estoque e auto-geracao de requisicao de compra ao salvar menu.
    - pedidos ganhou novos status operacionais (`Saiu para entrega`, `Recebido`).
  - client web:
    - historico de pedidos ganhou acao `Confirmar recebimento` (consumindo `confirm-receipt`).
    - rotulos de status em pt-BR atualizados para novo ciclo.
  - configuracao:
    - novas variaveis documentadas em `.env.example`:
      - `EMAIL_BACKEND`, `DEFAULT_FROM_EMAIL`, `PROCUREMENT_ALERT_FROM_EMAIL`,
      - `PROCUREMENT_WHATSAPP_WEBHOOK_URL`, `PROCUREMENT_WHATSAPP_WEBHOOK_TOKEN`.
  - migracoes:
    - `orders.0004_alter_order_status` criada/aplicada para refletir novos status.
  - validacao executada:
    - `bash scripts/quality_gate_all.sh` -> `OK` (`127 passed`, builds e smokes OK).

- T7.2.3-HF2 (26/02/2026): fluxo cliente web revisado (login -> pedido -> recebimento) e hardening localhost
  - client web:
    - nova secao `Jornada do cliente` no cardapio com passos de login, composicao, checkout, entrega e confirmacao de recebimento;
    - novo indicador de conectividade com a API (`ApiConnectionStatus`) para diagnostico rapido de endpoint/base URL;
    - checkout protegido por autenticacao com redirecionamento para `/conta?next=...`;
    - tela de Conta refatorada com guia operacional e redirecionamento seguro apos login/cadastro;
    - historico de pedidos com atualizacao manual/automatica (polling), CTA para login quando nao autenticado e confirmacao de recebimento mantida;
    - mensagens de erro de rede padronizadas com origem atual (sem dependencia fixa de porta 3001).
  - compatibilidade local:
    - `workspaces/web/client/next.config.ts` atualizado para `allowedDevOrigins` por hostname (suporte a execucao em `localhost:3000` e `localhost:3001`);
    - `README` do client atualizado com roteiro de execucao em `CLIENT_PORT=3000`.
  - portal:
    - links de Area do Cliente/Admin parametrizados por env com fallback local em desenvolvimento (`3001/3002`) para facilitar fluxo partindo de `localhost:3000`.
  - validacao executada:
    - `cd workspaces/web/client && npm run lint && npm run build`
    - `cd workspaces/web/portal && npm run lint && npm run build`
    - `bash scripts/quality_gate_all.sh`
    - `CLIENT_PORT=3000 bash scripts/smoke_client_dev.sh`

- T9.2.1-A2-HF6 (27/02/2026): gestao de e-mail no Web Admin + escopo correto da validacao de e-mail no login
  - backend/accounts:
    - regra de bloqueio de login por e-mail nao validado refinada para aplicar apenas ao fluxo cliente;
    - perfis administrativos/gestao (`is_staff`, `is_superuser`, `ADMIN`, `FINANCEIRO`, `COZINHA`, `COMPRAS`, `ESTOQUE`) passam a autenticar sem bloqueio de validacao de e-mail;
    - envio de e-mail de confirmacao passa a tentar usar configuracao de SMTP do Portal CMS com fallback seguro para backend padrao.
  - backend/portal:
    - novo campo `PortalConfig.email_settings` (migration `0009_portalconfig_email_settings`);
    - normalizacao/validacao de `email_settings` no serializer/service;
    - novo endpoint admin `POST /api/v1/portal/admin/config/test-email/` para validacao de configuracao SMTP.
  - web admin:
    - modulo `Portal CMS` ganhou secao `E-mail` com configuracao completa de SMTP, identidade de remetente e botao de envio de teste.
  - testes e validacao:
    - `python manage.py check` -> OK;
    - `python manage.py makemigrations --check` -> OK (com aviso de conectividade DB no ambiente);
    - `npm run lint` (web/admin) -> OK;
    - `npm run build` (web/admin) -> OK;
    - `pytest` backend bloqueado por indisponibilidade de conexao PostgreSQL no ambiente atual.

- T9.2.7-A1 (27/02/2026): modulo completo de gestao de clientes no Web Admin (ecommerce + LGPD)
  - backend/accounts:
    - novas entidades de governanca de cliente:
      - `CustomerGovernanceProfile` (status de conta, bloqueio de checkout, consentimentos e KYC);
      - `CustomerLgpdRequest` (protocolo, tipo/canal de solicitacao, prazo e resolucao);
    - migration adicionada: `accounts.0004_customergovernanceprofile_customerlgpdrequest`;
    - novo pacote administrativo:
      - `customer_services.py`, `customer_selectors.py`, `customer_serializers.py`, `customer_views.py`;
    - novas rotas:
      - `GET /api/v1/accounts/customers/`
      - `GET /api/v1/accounts/customers/<id>/`
      - `PATCH /api/v1/accounts/customers/<id>/profile/`
      - `PATCH /api/v1/accounts/customers/<id>/governance/`
      - `POST /api/v1/accounts/customers/<id>/status/`
      - `POST /api/v1/accounts/customers/<id>/consents/`
      - `POST /api/v1/accounts/customers/<id>/resend-email-verification/`
      - `GET/POST /api/v1/accounts/customers/<id>/lgpd-requests/`
      - `PATCH /api/v1/accounts/customers/lgpd-requests/<request_id>/status/`
      - `GET /api/v1/accounts/customers/overview/`;
    - validacao de elegibilidade de checkout integrada em `orders.create_order`, bloqueando conta suspensa/bloqueada.
  - web admin:
    - novo modulo `/modulos/clientes` com secoes:
      - gestao operacional (cadastro, status, KYC, consentimentos e LGPD),
      - compliance (LGPD e regras de governanca),
      - procedimentos operacionais;
    - navegação atualizada nos templates `admin-adminkit` e `admin-admindek`;
    - catalogo de modulos atualizado com card dedicado de clientes.
  - documentacao:
    - novo ADR `docs/adr/0010-governanca-clientes-lgpd-ecommerce.md`;
    - atualizacao dos documentos de dados/auth/roadmap/estado para refletir a trilha `T9.2.7`.

- T9.2.7-A2 (27/02/2026): modulo `Administracao do servidor` no Web Admin
  - web admin:
    - criado novo modulo `/modulos/administracao-servidor`;
    - paineis movidos do `Portal CMS` para o novo modulo:
      - `Gestao de e-mail`,
      - `Conectividade e dominio` (incluindo assistente de instalacao e recursos operacionais),
      - `Build e release mobile`;
    - `Portal CMS` ficou focado em:
      - `Template ativo`,
      - `Autenticacao social`,
      - `Pagamentos`,
      - `Conteudo dinamico`,
      - `Publicacao`;
    - refatoracao sem duplicidade:
      - `PortalSections` passou a operar em dois modos (`portal` e `server-admin`) com o mesmo estado/handlers;
      - novas hotpages apenas orquestram menu e filtro de secoes por modo.
  - navegacao:
    - menu lateral dos templates (`AdminKit` e `AdminDek`) atualizado com o novo modulo;
    - catalogo de modulos (`/modulos`) atualizado com card de `Administracao do servidor`.
  - validacao executada:
    - `npm run lint` (web/admin) -> OK;
    - `npm run build` (web/admin) -> OK;
    - `python manage.py check` (backend) -> OK;
    - `pytest tests/test_customers_admin_api.py` -> OK (`8 passed`).

- T9.2.7-A2-HF1 (27/02/2026): preloader global do Admin em modo nao bloqueante
  - problema corrigido:
    - alerta "Sincronizando operacao" aparecia em overlay de tela cheia com fundo ofuscado durante requisicoes recorrentes, prejudicando a operacao visual.
  - ajuste aplicado:
    - `GlobalNetworkPreloader` deixou de usar overlay full-screen;
    - indicador passou para formato discreto no canto superior direito + barra fina no topo;
    - exibicao com atraso (450ms) para evitar flicker em requests curtos.
  - resultado esperado:
    - sincronizacao continua visivel, mas transparente ao operador sem interromper leitura/uso da pagina.
  - validacao executada:
    - `npm run lint` (web/admin) -> OK;
    - `npm run build` (web/admin) -> OK.
